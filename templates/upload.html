{% include "header_minimal.html" %}
<div class="shared-banner">
  <span class="shared-label">Content shared via <a href="{{ args.public_path_as_str() }}/">MicroBin</a></span>
  <span class="pasta-ref">
    <a href="{{ args.public_path_as_str() }}/upload/{{pasta.id_as_animals()}}">{{pasta.id_as_animals()}}</a>
  </span>
</div>
<div class="pasta-toolbar">
  <div class="toolbar-primary">
    {% if args.public_path_as_str() != "" %}
    <a href="javascript:void(0)" id="copy-url-button">Copy Link</a>
    {%- endif %}
    {% if pasta.content != "" %}
    <a href="javascript:void(0)" id="copy-text-button">Copy Text</a>
    {%- endif %}
    {% if args.public_path_as_str() != "" && pasta.pasta_type == "url" %}
    <a href="javascript:void(0)" id="copy-redirect-button">Redirect</a>
    {%- endif %}
  </div>
  <div class="toolbar-secondary">
    {% if pasta.content != "" %}
    <a href="{{ args.public_path_as_str() }}/raw/{{pasta.id_as_animals()}}">Raw</a>
    {%- endif %}
    {% if args.qr && args.public_path_as_str() != "" %}
    <a href="{{ args.public_path_as_str() }}/qr/{{pasta.id_as_animals()}}">QR</a>
    {%- endif %}
    {% if pasta.editable && !pasta.encrypt_client %}
    <a href="{{ args.public_path_as_str() }}/edit/{{pasta.id_as_animals()}}">Edit</a>
    {%- endif %}
    {% if pasta.editable %}
    <a href="{{ args.public_path_as_str() }}/remove/{{pasta.id_as_animals()}}" class="action-danger">Remove</a>
    {%- endif %}
    {% if !args.no_listing %}
    <a href="{{ args.public_path_as_str() }}/list">More</a>
    {%- endif %}
  </div>
</div>
{% if pasta.encrypt_client %}
<span style="margin-left: auto; margin-right: auto; display: flex;
justify-content: center; align-items: center;">
  <div id="decryption">
    {% if pasta.encrypt_client %}
    <label id="decrypt-label" for="password-field" style="margin-bottom: 0.5em;">
      Please enter your key to decrypt this upload. <sup> <a href="{{ args.public_path_as_str() }}/guide#encryption">?</a></sup>
    </label>
    <input class="small-button" placeholder="Key" style="margin-right: 0.5rem" type="password" id="password-field"
      autocomplete="off" />
    {% if pasta.content != "" %}
    <button class="small-button" id="decrypt-button" style="margin-right:
    0.5rem">
      <b>
        Decrypt text
      </b>
    </button>
    {%- endif %}
    {%- endif %}
    {% if pasta.file.is_some() && !pasta.file_embeddable() %}
    <button class="small-button" id="download-button" style="margin-right:
  0.5rem">
      <b>
        Download {{pasta.file.as_ref().unwrap().display_name()}}
        [{{pasta.file.as_ref().unwrap().size}}]
      </b>
    </button>
    {%- endif %}
  </div>
</span>
{%- endif %}

<br>

{% if pasta.content != "" %}
<div class="code-container">
  <div style="clear: both;">
    {% if pasta.encrypt_client %}
    <!-- Client-encrypted: show escaped, will be decrypted by JS -->
    <pre><code id="code">{{pasta.content_escaped()}}</code></pre>
    {% else if pasta.should_render_markdown() %}
    <!-- Rendered Markdown -->
    <div id="markdown-content" class="markdown-body">
      {{pasta.content_rendered_markdown()|safe}}
    </div>
    {% else if pasta.should_render_html() %}
    <!-- Rendered HTML in sandboxed iframe -->
    <div id="html-content">
      <iframe
        sandbox="allow-same-origin"
        srcdoc="{{pasta.content_for_html_iframe()}}"
        style="width: 100%; min-height: 400px; border: 1px solid #ddd; border-radius: 6px;"
        title="HTML content">
      </iframe>
    </div>
    {% else if pasta.extension == "auto" %}
    <!-- Auto syntax highlighting via highlight.js -->
    <pre><code id="code">{{pasta.content_escaped()}}</code></pre>
    {% else if args.highlightsyntax && pasta.extension != "none" %}
    <!-- Server-side syntax highlighting -->
    <pre><code id="code">{{pasta.content_syntax_highlighted()}}</code></pre>
    {% else %}
    <!-- Plain text, no highlighting -->
    <pre><code id="code">{{pasta.content_not_highlighted()}}</code></pre>
    {%- endif %}
  </div>
</div>
{%- endif %}

{% if pasta.file.is_some() && !pasta.file_embeddable() && !pasta.encrypt_client %}
<span style="margin-left: auto; margin-right: auto; display: flex;
    justify-content: center; align-items: center;">
  <p style="font-size: small;">{{pasta.file.as_ref().unwrap().display_name()}}
    [{{pasta.file.as_ref().unwrap().size}}]</p>
  <a href="{{ args.public_path_as_str()}}/file/{{pasta.id_as_animals()}}" id="download-link">
    <button class="download-button" autofocus>
      Download
    </button>
  </a>
</span>
{%- endif %}


{% if pasta.file.is_some() && pasta.file.as_ref().unwrap().is_image() &&
pasta.file_embeddable() && !pasta.encrypt_client %}
<div class="image-container" id="image-container">
  <div class="image-loading" id="image-loading">
    <div class="loading-spinner"></div>
    <span>Loading image...</span>
  </div>
  <img id="embed" src="{{ args.public_path_as_str()}}/file/{{pasta.id_as_animals()}}"
       style="max-height: 50vh; max-width: 100%; height: auto; width: auto; display: none;"
       onload="document.getElementById('image-loading').style.display='none'; this.style.display='block';"
       onerror="document.getElementById('image-loading').innerHTML='<span style=\'color: #999;\'>Failed to load image</span>';" />
</div>
<span style="margin-left: auto; margin-right: auto; display: flex;
  justify-content: center; align-items: center;">
  <p style="font-size: small;">{{pasta.file.as_ref().unwrap().display_name()}}
    [{{pasta.file.as_ref().unwrap().size}}]</p>
  <a href="{{ args.public_path_as_str()      }}/file/{{pasta.id_as_animals()}}" id="download-link" download>
    <button class="download-button" autofocus>
      Download
    </button>
  </a>
</span>
{%- endif %}


{% if pasta.file.is_some() && pasta.file.as_ref().unwrap().is_video() &&
pasta.file_embeddable() && !pasta.encrypt_client %}
<video id="embed" controls src="{{ args.public_path_as_str()}}/file/{{pasta.id_as_animals()}}" height="300"></video>
<span style="margin-left: auto; margin-right: auto; display: flex;
  justify-content: center; align-items: center;">
  <p style="font-size: small;">{{pasta.file.as_ref().unwrap().display_name()}}
    [{{pasta.file.as_ref().unwrap().size}}]</p>
  <a href="{{ args.public_path_as_str()      }}/file/{{pasta.id_as_animals()}}" download id="download-link">
    <button class="download-button">
      Download
    </button>
  </a>
</span>
{%- endif %}

<div style="padding: 0 10px;">
  {% if args.show_read_stats %} {% if pasta.read_count == 1 %}
  <p style="font-size: small">Read {{pasta.read_count}} time, last
    {{pasta.last_read_time_ago_as_string()}}</p>
  {%- else %}
  <p style="font-size: small">Read {{pasta.read_count}} times, last
    {{pasta.last_read_time_ago_as_string()}}</p>
  {%- endif %} {%- endif %}

</div>

<br>

<script type="text/javascript" src="{{ args.public_path_as_str() }}/static/highlight/highlight.min.js"></script>
<link rel="stylesheet" href="{{ args.public_path_as_str()}}/static/highlight/highlight.min.css">

<script>
  const copyURLBtn = document.getElementById("copy-url-button")
  const copyTextBtn = document.getElementById("copy-text-button")
  const copyRedirectBtn = document.getElementById("copy-redirect-button")
  var content = `{{ pasta.content_escaped() }}`
  const contentElement = document.getElementById("code");
  const url = (`{{ args.short_path_as_str()}}` === "") ? `{{ args.public_path_as_str() }}/upload/{{pasta.id_as_animals()}}` : `{{ args.short_path_as_str()}}/p/{{pasta.id_as_animals()}}`
  const redirect_url = (`{{ args.short_path_as_str()}}` === "") ? `{{ args.public_path_as_str() }}/url/{{pasta.id_as_animals()}}` : `{{ args.short_path_as_str()}}/u/{{pasta.id_as_animals()}}`

  const te = new TextEncoder();

  // {% if pasta.extension == "auto" && !pasta.encrypt_client %}
  onload = (event) => {
    contentElement.innerHTML = content;
    hljs.highlightAll();
    contentElement.innerHTML =
      wrapStringInCodeLines(contentElement.innerHTML);
  };
  // {% endif %}


  function copyToClipboard(text, buttonElement, originalLabel) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        showCopiedFeedback(buttonElement, originalLabel);
      }).catch(err => {
        console.error('Failed to copy using Clipboard API: ', err);
        fallbackCopyTextToClipboard(text, buttonElement, originalLabel);
      });
    } else {
      fallbackCopyTextToClipboard(text, buttonElement, originalLabel);
    }
  }

  function fallbackCopyTextToClipboard(text, buttonElement, originalLabel) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Ensure it's not visible but part of the DOM
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    document.body.appendChild(textArea);
    
    textArea.focus();
    textArea.select();

    try {
      var successful = document.execCommand('copy');
      if (successful) {
        showCopiedFeedback(buttonElement, originalLabel);
      } else {
        console.error('Fallback: Copying text command was unsuccessful');
      }
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
    }

    document.body.removeChild(textArea);
  }

  function showCopiedFeedback(buttonElement, originalLabel) {
    buttonElement.innerHTML = "Copied";
    setTimeout(() => {
      buttonElement.innerHTML = originalLabel;
    }, 1000);
  }

  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function wrapStringInCodeLines(str) {
    const lines = str.split(/\r?\n/); // split the string into an array of lines
    const wrappedLines = lines.map((line) => `<code-line>${line}</code-line>`); // wrap each line in a "code-line" tag
    return wrappedLines.join("\n"); // join the wrapped lines back into a single string with line breaks
  }

  const decodeEntity = (inputStr) => {
    var textarea = document.createElement("textarea");
    textarea.innerHTML = inputStr;
    return textarea.value;
  }

  if (copyURLBtn) {
    copyURLBtn.addEventListener("click", () => {
      copyToClipboard(url, copyURLBtn, "Copy Link");
    })
  }
  if (copyRedirectBtn) {
    copyRedirectBtn.addEventListener("click", () => {
      copyToClipboard(redirect_url, copyRedirectBtn, "Redirect");
    })
  }

  if (copyTextBtn) {
    copyTextBtn.addEventListener("click", () => {
      const decodeContent = decodeEntity(content)
      copyToClipboard(decodeContent, copyTextBtn, "Copy Text");
    })
  }
  
  // {% if pasta.encrypt_client %}

  const decryptDiv = document.getElementById('decryption');
  const decryptButton = document.getElementById('decrypt-button');
  const passwordField = document.getElementById("password-field");
  const downloadButton = document.getElementById('download-button');

  // {% if pasta.file.is_some() %}
  // Set up event listener for download link click
  downloadButton.addEventListener('click', async (event) => {
    event.preventDefault(); // prevent default click behavior

    if (passwordField.value.trim() == "") {
      passwordField.focus();
      return false;
    }

    // Fetch encrypted file from server
    const formData = new FormData();

    // {% if pasta.encrypted_key.is_some() %}
    let key = decryptWithPassword(passwordField.value.trim(), "{{ pasta.encrypted_key.as_ref().unwrap() }}");
    // {%- endif %}
    formData.append('password', key);

    const response = await fetch('{{ args.public_path_as_str() }}/secure_file/{{ pasta.id_as_animals() }}', {
      method: 'POST',
      body: formData,
    })

    // {% if pasta.file.is_some() %}
    const encryptedFile = await response.text();

    // Decrypt file contents
    const decryptedContents = decryptFileWithPassword(passwordField.value.trim(), encryptedFile);
    if (!decryptedContents) {
      throw new Error('Failed to decrypt file');
    }

    // Create blob from decrypted file contents
    const decryptedBlob = new Blob([decryptedContents], { type: 'application/octet-stream' });

    // Create data URI for decrypted file
    // const dataUri = `data:application/octet-stream;${encodeURIComponent(decryptedContents)}`;

    // Create temporary anchor element
    const tempAnchorEl = document.createElement('a');
    // tempAnchorEl.href = dataUri;
    tempAnchorEl.href = URL.createObjectURL(decryptedBlob);
    tempAnchorEl.download = '{{pasta.file.as_ref().unwrap().display_name()}}';

    // Programmatically click anchor element to trigger download
    tempAnchorEl.click();

    // {%- endif %}
  });
  // {% endif  %} 

  function doDecrypt(pwd) {
    content = contentDecrypted = escapeHtml(decryptWithPassword(pwd, content));
    if (contentDecrypted) {
      contentElement.innerHTML = contentDecrypted;
      // {% if pasta.extension == "auto" %}
      hljs.highlightAll();
      // {% endif  %}
      contentElement.innerHTML = wrapStringInCodeLines(contentElement.innerHTML);
      // Hide text decryption UI but keep download button visible
      const decryptLabel = document.getElementById('decrypt-label');
      if (decryptLabel) decryptLabel.style.display = 'none';
      if (decryptButton) decryptButton.style.display = 'none';
      // Keep password field for file download, but hide if no file
      if (!downloadButton) {
        decryptDiv.style.display = 'none';
      }
    }
  }

  decryptButton.addEventListener("click", () => {
    password = passwordField.value;
    doDecrypt(password);
  });

  // Auto-decrypt if password was stored from auth page
  (function() {
    const storedKey = sessionStorage.getItem("microbin_decrypt_key");
    if (storedKey) {
      sessionStorage.removeItem("microbin_decrypt_key");
      passwordField.value = storedKey;
      doDecrypt(storedKey);
    }
  })();

  function decryptWithPassword(password, encryptedHex) {
    const passwordBytes = aesjs.utils.utf8.toBytes(password.padStart(32, "#"));
    const encryptedBytes = aesjs.utils.hex.toBytes(encryptedHex);
    const aesCtr = new aesjs.ModeOfOperation.ctr(passwordBytes);
    const decryptedBytes = aesCtr.decrypt(encryptedBytes);
    const res = aesjs.utils.utf8.fromBytes(decryptedBytes);

    if (res.endsWith("!0K")) {
      return res.substring(0, res.length - "!0K".length);
    } else {
      return null;
    }
  }

  function decryptFileWithPassword(password, encryptedHex) {
    const passwordBytes = aesjs.utils.utf8.toBytes(password.padStart(32, "#"));
    const encryptedBytes = aesjs.utils.hex.toBytes(encryptedHex);
    const aesCtr = new aesjs.ModeOfOperation.ctr(passwordBytes);
    const decryptedBytes = aesCtr.decrypt(encryptedBytes);
    return decryptedBytes;
  }
// {% endif %}
</script>

<style>
  .shared-banner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem 10px;
    margin-bottom: 0.75rem;
    font-size: 0.85em;
    color: #888;
    border-bottom: 1px solid #eee;
  }

  .shared-banner a {
    color: inherit;
    text-decoration: none;
    font-weight: 600;
  }

  .shared-banner a:hover {
    text-decoration: underline;
  }

  .pasta-ref a {
    font-family: monospace;
    font-size: 0.9em;
    color: #aaa;
  }

  .pasta-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0 10px;
    margin-bottom: 1rem;
    font-size: 0.9em;
  }

  .toolbar-primary, .toolbar-secondary {
    display: flex;
    gap: 0.75rem;
  }

  .toolbar-primary a {
    text-decoration: none;
    font-weight: 500;
  }

  .toolbar-primary a:hover {
    text-decoration: underline;
  }

  .toolbar-secondary {
    font-size: 0.9em;
    opacity: 0.45;
  }

  .toolbar-secondary:hover {
    opacity: 0.75;
  }

  .toolbar-secondary a {
    text-decoration: none;
    color: inherit;
  }

  .toolbar-secondary a:hover {
    text-decoration: underline;
  }

  .toolbar-secondary .action-danger {
    opacity: 0.7;
  }

  .toolbar-secondary .action-danger:hover {
    opacity: 1;
  }

  code-line {
    counter-increment: line;
    text-align: right;
    float: left;
    clear: left;
  }

  code-line::before {
    content: counter(line);
    display: inline-block;
    padding-left: auto;
    margin-left: auto;
    text-align: left;
    width: 1.8rem;
    border-right: 1px solid lightgrey;
    color: grey;
    margin-right: 0.4rem;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  #code {
    min-height: 2rem;
  }

  #embed {
    background-color: #f7f7f7;
    border-radius: 6px;
    margin-top: 1rem;
    margin-bottom: 1rem;
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
    max-height: 480px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .image-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 200px;
  }

  .image-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    color: #666;
    font-size: 0.9em;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #2975D2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .download-button {
    margin-left: 1rem;
    font-size: small;
    padding: 4px;
    padding-left: 0.8rem;
    padding-right: 0.8rem;
    cursor: pointer;
  }

  .code-container {
    position: relative;
  }

  .hidden {
    display: none;
  }

  .small-button {
    font-size: small;
    padding: 4px;
    padding-left: 0.8rem;
    padding-right: 0.8rem;
    cursor: pointer;
  }

  /* Markdown rendered content styles */
  .markdown-body {
    padding: 0 10px;
    line-height: 1.6;
  }

  .markdown-body > *:first-child {
    margin-top: 0;
  }

  .markdown-body h1, .markdown-body h2, .markdown-body h3,
  .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: 600;
  }

  .markdown-body h1 { font-size: 2em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
  .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
  .markdown-body h3 { font-size: 1.25em; }

  .markdown-body pre {
    background-color: #f6f8fa;
    border-radius: 6px;
    padding: 1em;
    overflow-x: auto;
  }

  .markdown-body code {
    background-color: rgba(175, 184, 193, 0.2);
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-size: 85%;
    font-family: monospace;
  }

  .markdown-body pre code {
    background: none;
    padding: 0;
  }

  .markdown-body table {
    border-collapse: collapse;
    width: 100%;
    margin: 1em 0;
  }

  .markdown-body th, .markdown-body td {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: left;
  }

  .markdown-body th {
    background-color: #f6f8fa;
    font-weight: 600;
  }

  .markdown-body blockquote {
    border-left: 4px solid #ddd;
    margin: 1em 0;
    padding-left: 1em;
    color: #666;
  }

  .markdown-body ul, .markdown-body ol {
    padding-left: 2em;
  }

  .markdown-body li {
    margin: 0.25em 0;
  }

  .markdown-body img {
    max-width: 100%;
    height: auto;
  }

  .markdown-body a {
    color: #0366d6;
  }

  .markdown-body hr {
    border: none;
    border-top: 1px solid #eee;
    margin: 1.5em 0;
  }

  .markdown-body p {
    margin: 1em 0;
  }

  /* Task list checkboxes */
  .markdown-body input[type="checkbox"] {
    margin-right: 0.5em;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .markdown-body pre {
      background-color: #161b22;
    }
    .markdown-body code {
      background-color: rgba(110, 118, 129, 0.4);
    }
    .markdown-body th {
      background-color: #161b22;
    }
    .markdown-body blockquote {
      border-left-color: #3b434b;
      color: #8b949e;
    }
    .markdown-body h1, .markdown-body h2 {
      border-bottom-color: #21262d;
    }
    .markdown-body th, .markdown-body td {
      border-color: #30363d;
    }
    .markdown-body a {
      color: #58a6ff;
    }
    .markdown-body hr {
      border-top-color: #21262d;
    }
    #html-content iframe {
      border-color: #30363d;
    }
    .shared-banner {
      color: #7a8490;
      border-bottom-color: #21262d;
    }
    .pasta-ref a {
      color: #555d66;
    }
  }
</style>

{% if !args.pure_html %}
<style>
  #decryption {
    background-color: #f7f7f7;
    border-radius: 6px;
    padding: 10px;
    width: fit-content;
  }
</style>
{% endif %}

{% include "footer.html" %}