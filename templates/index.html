{% include "header.html" %}
<div style="padding: 0 10px;">
<form id="pasta-form" action="{{ args.public_path_as_str() }}/upload" method="POST" enctype="multipart/form-data" autocomplete="off">
    <div id="settings">
        <div>
            <label for="expiration">Expiration <sup> <a href="{{ args.public_path_as_str() }}/guide#expiration">?</a></sup></label><br>
            <select style="width: 100%;" name="expiration" id="expiration">
                <optgroup label="Expire after">
                    {% if args.default_expiry == "1min" %}
                    <option selected value="1min">
                        {%- else %}
                    <option value="1min">
                        {%- endif %} 1 minute
                    </option>
                    {% if args.default_expiry == "10min" %}
                    <option selected value="10min">
                        {%- else %}
                    <option value="10min">
                        {%- endif %} 10 minutes
                    </option>
                    {% if args.default_expiry == "1hour" %}
                    <option selected value="1hour">
                        {%- else %}
                    <option value="1hour">
                        {%- endif %} 1 hour
                    </option>
                    {% if args.default_expiry == "24hour" %}
                    <option selected value="24hour">
                        {%- else %}
                    <option value="24hour">
                        {%- endif %} 24 hours
                    </option>
                    {% if args.default_expiry == "3days" %}
                    <option selected value="3days">
                        {%- else %}
                    <option value="3days">
                        {%- endif %} 3 days
                    </option>
                    {% if args.default_expiry == "1week" %}
                    <option selected value="1week">
                        {%- else %}
                    <option value="1week">
                        {%- endif %} 1 week
                    </option>
                </optgroup>
                {% if args.eternal_pasta %} {% if args.default_expiry ==
                "never" %}
                <option selected value="never">
                    {%- else %}
                <option value="never">{%- endif %} Never Expire
                </option>
                {%- endif %}
            </select>
        </div>
        {% if args.enable_burn_after %}
        <div>
            <label for="burn_after">Burn After <sup> <a href="{{ args.public_path_as_str() }}/guide#burn-after">?</a></sup></label><br>
            <select style="width: 100%;" name="burn_after" id="burn_after">
                {% if args.default_burn_after == 0 %}
                <option selected value="0">
                    {%- else %}
                <option value="0">
                    {%- endif %} No Limit
                </option>
                <optgroup label="Burn after">
                    {% if args.default_burn_after == 1 %}
                    <option selected value="1">
                        {%- else %}
                    <option value="1">
                        {%- endif %} First Read
                    </option>
                    {% if args.default_burn_after == 10 %}
                    <option selected value="10">
                        {%- else %}
                    <option value="10">
                        {%- endif %} 10th Read
                    </option>
                    {% if args.default_burn_after == 100 %}
                    <option selected value="100">
                        {%- else %}
                    <option value="100">
                        {%- endif %} 100th Read
                    </option>
                    {% if args.default_burn_after == 1000 %}
                    <option selected value="1000">
                        {%- else %}
                    <option value="1000">
                        {%- endif %} 1000th Read
                    </option>
                    {% if args.default_burn_after == 10000 %}
                    <option selected value="10000">
                        {%- else %}
                    <option value="10000">
                        {%- endif %} 10000th Read
                    </option>
                </optgroup>
            </select>
        </div>
        {%- endif %}

        {% if args.highlightsyntax %}
        <div>
            <label for="syntax_highlight">Format <sup> <a href="{{ args.public_path_as_str() }}/guide#syntax">?</a></sup></label><br>
            <select style="width: 100%;" name="syntax_highlight" id="syntax_highlight">
                {% if args.render_markdown %}
                <option value="md" {% if args.default_syntax == "md" %}selected{% endif %}>Markdown</option>
                {% endif %}
                <option value="none" {% if args.default_syntax == "none" %}selected{% endif %}>Plain Text</option>
                {% if args.render_html %}
                <option value="html" {% if args.default_syntax == "html" %}selected{% endif %}>HTML (iframe)</option>
                {% endif %}
                <option value="sh" {% if args.default_syntax == "sh" %}selected{% endif %}>Bash Shell</option>
                <option value="c" {% if args.default_syntax == "c" %}selected{% endif %}>C</option>
                <option value="cpp" {% if args.default_syntax == "cpp" %}selected{% endif %}>C++</option>
                <option value="cs" {% if args.default_syntax == "cs" %}selected{% endif %}>C#</option>
                <option value="pas" {% if args.default_syntax == "pas" %}selected{% endif %}>Delphi</option>
                <option value="erl" {% if args.default_syntax == "erl" %}selected{% endif %}>Erlang</option>
                <option value="go" {% if args.default_syntax == "go" %}selected{% endif %}>Go</option>
                <option value="hs" {% if args.default_syntax == "hs" %}selected{% endif %}>Haskell</option>
                <option value="java" {% if args.default_syntax == "java" %}selected{% endif %}>Java</option>
                <option value="js" {% if args.default_syntax == "js" %}selected{% endif %}>JavaScript</option>
                <option value="json" {% if args.default_syntax == "json" %}selected{% endif %}>JSON</option>
                <option value="kt" {% if args.default_syntax == "kt" %}selected{% endif %}>Kotlin</option>
                <option value="lisp" {% if args.default_syntax == "lisp" %}selected{% endif %}>Lisp</option>
                <option value="lua" {% if args.default_syntax == "lua" %}selected{% endif %}>Lua</option>
                <option value="php" {% if args.default_syntax == "php" %}selected{% endif %}>PHP</option>
                <option value="py" {% if args.default_syntax == "py" %}selected{% endif %}>Python</option>
                <option value="r" {% if args.default_syntax == "r" %}selected{% endif %}>R</option>
                <option value="rb" {% if args.default_syntax == "rb" %}selected{% endif %}>Ruby</option>
                <option value="rs" {% if args.default_syntax == "rs" %}selected{% endif %}>Rust</option>
                <option value="sc" {% if args.default_syntax == "sc" %}selected{% endif %}>Scala</option>
                <option value="swift" {% if args.default_syntax == "swift" %}selected{% endif %}>Swift</option>
                <option value="xml" {% if args.default_syntax == "xml" %}selected{% endif %}>XML</option>
                <option value="yaml" {% if args.default_syntax == "yaml" %}selected{% endif %}>YAML</option>
            </select>
        </div>
        {%- else %}
        <input type="hidden" name="syntax_highlight" value="{{ args.default_syntax }}">
        {%- endif %}

        <div>
            <label for="privacy">Privacy <sup> <a href="{{ args.public_path_as_str() }}/guide#privacy">?</a></sup></label><br>
            <select style="width: 100%;" name="privacy" id="privacy">
                <option value="public" {% if args.default_privacy == "public" %}selected{% endif %}>Public</option>
                {% if args.private %}
                <option value="unlisted" {% if args.default_privacy == "unlisted" %}selected{% endif %}>Unlisted</option>
                {%- endif %}
                {% if args.encryption_client_side %}
                <option value="secret" {% if args.default_privacy == "secret" %}selected{% endif %}>Secret</option>
                {%- endif %}
            </select>
        </div>

        {% if args.encryption_client_side %}
        <div id="password_placeholder" style="display: none;"></div>
        {%- endif %}

    </div>

    <!-- Content section -->
    <label>Content</label>
    <div id="content_textarea_placeholder"></div>

    <!-- File attachment and Submit button on same line -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        {% if !args.no_file_upload %}
        <div id="file-select">
            <label for="file" id="attach-file-button-label"><a role="button" id="attach-file-button">Select or drop file
                    attachment</a></label>
            <input type="file" id="file" name="file" />
        </div>
        {% else %}
        <div></div>
        {% endif %}

        {% if args.readonly && !has_uploader_cookie %}
        <button type="button" id="signin-button" style="padding: 0 20px; background-color: #2975D2; color: white; height: 32px; border: none; cursor: pointer; white-space: nowrap;">Sign in to Share</button>
        {% else %}
        <input style="width: 140px; background-color: #2975D2; color: white;" id="submit-button" type="submit" value="Save" />
        {% endif %}
    </div>

    <input type="hidden" name="content" id="content">
    <input type="hidden" name="encrypt_client" id="encrypt_client">
    {% if args.encryption_server_side || args.enable_readonly %}
    <input name="encrypted_random_key" type="hidden" id="encrypted_random_key" autocomplete="off" />
    {%- endif %}
    <input type="hidden" name="random_key" id="random_key">
    <input type="hidden" name="plain_key" id="plain_key">
</form>

{% if args.encryption_client_side %}
<form id="password-form" onsubmit="return false;">
    <label for="password_field">Password <sup><a href="{{ args.public_path_as_str() }}/guide#password">?</a></sup></label><br>
    <input style="width: 130px; height: 28px;" type="password" id="password_field" autocomplete="off" />
</form>
{%- endif %}

<!-- Content textarea in isolated form (prevents iCloud from interfering) -->
<form id="content-form" onsubmit="return false;">
    <textarea style="width: 100%; min-height: 100px; margin-bottom: 2em; font-family: monospace;" id="content-input"
        class="code-editor no-password-save" role="textbox" aria-multiline="true"
        autofocus autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
        data-gramm="false" data-form-type="other" data-1p-ignore data-lpignore="true" data-bwignore
        placeholder="Type something here."></textarea>
</form>

</div>

{% if args.readonly && !has_uploader_cookie %}
<!-- Login Modal - isolated outside main container to prevent iCloud double-prompt -->
<div id="login-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 style="margin-top: 0;">Sign In</h3>
        <p>Please enter your password to save content.</p>
        <form id="login-form" method="post" action="{{ args.public_path_as_str() }}/login">
            <input type="text" name="username" value="MicroBin" autocomplete="username"
                style="position: absolute; left: -9999px;" tabindex="-1" aria-hidden="true" />
            <input type="password" id="login-password" name="password"
                autocomplete="current-password" required
                placeholder="Password"
                style="width: 100%; padding: 8px; margin-bottom: 1rem; box-sizing: border-box;" />
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="button" id="modal-cancel" style="padding: 8px 16px; cursor: pointer;">Cancel</button>
                <button type="submit" style="padding: 8px 16px; background-color: #2975D2; color: white; border: none; cursor: pointer;">Sign In</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
<script>
    // Move forms into placeholders to isolate them from main form
    // This prevents iCloud extension from interfering
    (function() {
        // Move secret password form
        const passwordPlaceholder = document.getElementById("password_placeholder");
        const passwordForm = document.getElementById("password-form");
        if (passwordPlaceholder && passwordForm) {
            passwordPlaceholder.appendChild(passwordForm);
        }

        // Move content textarea form
        const contentPlaceholder = document.getElementById("content_textarea_placeholder");
        const contentForm = document.getElementById("content-form");
        if (contentPlaceholder && contentForm) {
            contentPlaceholder.appendChild(contentForm);
        }
    })();

    const form = document.getElementById("pasta-form");
    const submitButton = document.getElementById("submit-button");
    const passwordField = document.getElementById("password_field");
    const privacyDropdown = document.getElementById("privacy");
    const passwordPlaceholder = document.getElementById("password_placeholder");

    // Show/hide password field based on privacy selection
    function updatePasswordVisibility() {
        if (passwordPlaceholder) {
            if (privacyDropdown.value === "secret") {
                passwordPlaceholder.style.display = "";
            } else {
                passwordPlaceholder.style.display = "none";
                if (passwordField) passwordField.value = "";
            }
        }
    }
    if (privacyDropdown) {
        privacyDropdown.addEventListener("change", updatePasswordVisibility);
        updatePasswordVisibility();
    }
    const contentInput = document.getElementById("content-input");
    const content = document.getElementById("content");
    const attachFileButton = document.getElementById('attach-file-button');
    const dropContainer = document.getElementById('pasta-form');
    const hiddenFileButton = document.getElementById('file');
    const hiddenRandomKeyField = document.getElementById("random_key");
    const hiddenEncryptedRandomKeyField = document.getElementById("encrypted_random_key");
    const hiddenPlainKeyField = document.getElementById("plain_key");
    const hiddenEncryptedClientSide = document.getElementById("encrypt_client");

    const te = new TextEncoder();

    // Restore all form data from SessionStorage on page load
    const savedContent = sessionStorage.getItem('microbin_draft_content');
    const savedSettings = sessionStorage.getItem('microbin_draft_settings');
    if (savedContent) {
        contentInput.value = savedContent;
        sessionStorage.removeItem('microbin_draft_content');
    }
    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);
            // Restore select dropdowns
            const expirationSelect = document.getElementById('expiration');
            const burnAfterSelect = document.getElementById('burn_after');
            const syntaxSelect = document.getElementById('syntax_highlight');

            if (expirationSelect && settings.expiration) expirationSelect.value = settings.expiration;
            if (burnAfterSelect && settings.burn_after) burnAfterSelect.value = settings.burn_after;
            if (syntaxSelect && settings.syntax_highlight) syntaxSelect.value = settings.syntax_highlight;
            if (privacyDropdown && settings.privacy) {
                privacyDropdown.value = settings.privacy;
                // Trigger visibility update for password field
                updatePasswordVisibility();
            }
            // Restore secret password if it was set
            if (passwordField && settings.secret_password) {
                passwordField.value = settings.secret_password;
            }
        } catch (e) {
            console.error('Failed to restore settings:', e);
        }
        sessionStorage.removeItem('microbin_draft_settings');
    }

    // {% if args.readonly && !has_uploader_cookie %}
    const signinButton = document.getElementById('signin-button');
    const loginModal = document.getElementById('login-modal');
    const loginPassword = document.getElementById('login-password');
    const modalCancel = document.getElementById('modal-cancel');

    // Save all form settings to SessionStorage
    function saveFormSettings() {
        // Save content
        if (contentInput.value.trim()) {
            sessionStorage.setItem('microbin_draft_content', contentInput.value);
        }
        // Save all form settings
        const settings = {
            expiration: document.getElementById('expiration')?.value,
            burn_after: document.getElementById('burn_after')?.value,
            syntax_highlight: document.getElementById('syntax_highlight')?.value,
            privacy: privacyDropdown?.value,
            secret_password: passwordField?.value || ''
        };
        sessionStorage.setItem('microbin_draft_settings', JSON.stringify(settings));
    }

    // Show modal when clicking "Sign in to Share"
    if (signinButton) {
        signinButton.addEventListener('click', function() {
            saveFormSettings();
            loginModal.style.display = 'flex';
            setTimeout(() => loginPassword.focus(), 100);
        });
    }

    // Cancel button closes modal
    if (modalCancel) {
        modalCancel.addEventListener('click', function() {
            loginModal.style.display = 'none';
            loginPassword.value = '';
        });
    }

    // Close modal when clicking outside
    if (loginModal) {
        loginModal.addEventListener('click', function(e) {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
                loginPassword.value = '';
            }
        });
    }
    // {%- endif %}

    // Form submit handler (only works when user is logged in and submitButton exists)
    if (submitButton) {
        form.onsubmit = async function (event) {
            event.preventDefault();
            return doActualSubmit();
        };
    }

    async function doActualSubmit() {
        // {% if args.encryption_client_side || args.encryption_server_side || args.enable_readonly %}
        if (passwordField && passwordField.value.trim() != "") {
            // {% if !args.no_file_upload %}
            if (fileOversized()) return false;
            // {%- endif %}

            if (privacyDropdown.value == "secret") {
                let randomKey = Array.from(Array(16), () => Math.floor(Math.random() * 36).toString(36)).join('');
                if (hiddenRandomKeyField) hiddenRandomKeyField.value = randomKey;
                if (hiddenEncryptedRandomKeyField) hiddenEncryptedRandomKeyField.value = encryptWithPassword(passwordField.value, randomKey);
                if (contentInput.value.trim() != "") {
                    content.value = encryptWithPassword(passwordField.value.trim(), contentInput.value);
                } else {
                    content.value = contentInput.value;
                }
                if (hiddenPlainKeyField) hiddenPlainKeyField.name = "";
                // {% if !args.no_file_upload %}
                await encryptFile();
                // {%- endif %}
            } else {
                if (hiddenPlainKeyField) hiddenPlainKeyField.value = passwordField.value;
                if (hiddenEncryptedClientSide) hiddenEncryptedClientSide.name = "";
                if (hiddenEncryptedRandomKeyField) hiddenEncryptedRandomKeyField.name = "";
                if (hiddenRandomKeyField) hiddenRandomKeyField.name = "";
                content.value = contentInput.value;
            }
        } else {
            if (privacyDropdown.value != "public" && privacyDropdown.value != "unlisted") {
                if (passwordField) passwordField.focus();
                return false;
            }
            if (hiddenEncryptedClientSide) hiddenEncryptedClientSide.name = "";
            content.value = contentInput.value;
        }
        // {%- else %}
        if (hiddenEncryptedClientSide) hiddenEncryptedClientSide.name = "";
        content.value = contentInput.value;
        // {%- endif %}

        if (contentInput.value.trim() == "" && (hiddenFileButton == undefined || hiddenFileButton.files.length == 0)) {
            contentInput.focus();
            return false;
        }

        let showProgress = false;

        submitButton.disabled = true;
        submitButton.textContent = 'Uploading...';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ args.public_path_as_str() }}/upload', true);

        xhr.upload.onprogress = function (event) {
            if (showProgress) {
                const progressPercent = Math.round((event.loaded / event.total) * 100);
                submitButton.value = `${progressPercent}%`;
            }
        };

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200 || xhr.status === 302) {
                    window.location.href = xhr.responseURL;
                } else {
                    console.log('Request failed with status:', xhr.status);
                }
            }
        };

        const formData = new FormData(form);
        xhr.send(formData);

        showProgressTimeout = setTimeout(() => {
            showProgress = true;
        }, 1000);
    }

    function encryptWithPassword(password, plaintext) {
        const passwordBytes = aesjs.utils.utf8.toBytes(password.padStart(32, "#"));
        const plaintextBytes = aesjs.utils.utf8.toBytes(plaintext + "!0K");
        const aesCtr = new aesjs.ModeOfOperation.ctr(passwordBytes);
        const encryptedBytes = aesCtr.encrypt(plaintextBytes);
        return aesjs.utils.hex.fromBytes(encryptedBytes);
    }

    // {% if !args.no_file_upload %}
    function encryptFileWithPassword(password, bytes) {
        const passwordBytes = aesjs.utils.utf8.toBytes(password.padStart(32, "#"));
        const aesCtr = new aesjs.ModeOfOperation.ctr(passwordBytes);
        const encryptedBytes = aesCtr.encrypt(bytes);
        return aesjs.utils.hex.fromBytes(encryptedBytes);
    }

    function fileOversized() {
        if (hiddenFileButton.files.length > 0) {
            const fileSize = hiddenFileButton.files.item(0).size;
            const fileSizeMb = fileSize / 1024 ** 2;

            if (privacyDropdown.value == "secret") {
                if (fileSizeMb >
                    parseInt("{{ args.max_file_size_encrypted_mb }}")) {
                    attachFileButton.textContent = "Please select a file smaller than {{ args.max_file_size_encrypted_mb }} MB";
                    this.value = "";
                    return true;
                }
            } else {
                if (fileSizeMb >
                    parseInt("{{ args.max_file_size_unencrypted_mb }}")) {
                    attachFileButton.textContent = "Please select a file smaller than {{ args.max_file_size_unencrypted_mb }} MB";
                    this.value = "";
                    return true;
                }
            }
        }
        return false;
    }

    function encryptFile() {
        return new Promise((resolve, reject) => {
            if (hiddenFileButton.files.length > 0) {
                const file = hiddenFileButton.files[0];

                const reader = new FileReader();
                reader.onload = function (event) {
                    const encryptedContents = encryptFileWithPassword(passwordField.value.trim(), new Uint8Array(event.target.result));

                    // Replace selected file with its encrypted version
                    const encryptedFile = new File([encryptedContents], file.name, { type: file.type });

                    let container = new DataTransfer();
                    container.items.add(encryptedFile);
                    hiddenFileButton.files = container.files;
                    resolve(encryptedFile);
                };
                reader.readAsArrayBuffer(file);
            } else {
                resolve();
            }
        });
    }

    // Handle .md and .html files specially - read content into textarea
    function handleFileAsContent(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'md' || ext === 'html') {
            const reader = new FileReader();
            reader.onload = function(e) {
                contentInput.value = e.target.result;
                // Set syntax highlighting dropdown if it exists
                const syntaxDropdown = document.getElementById('syntax_highlight');
                if (syntaxDropdown) {
                    syntaxDropdown.value = ext;
                }
                // Clear the file attachment since we're using it as content
                hiddenFileButton.value = '';
                attachFileButton.textContent = "Select or drop file attachment";
            };
            reader.readAsText(file);
            return true; // File was handled as content
        }
        return false; // File should be handled as attachment
    }

    hiddenFileButton.addEventListener('change', function () {
        if (this.files.length > 0) {
            if (!handleFileAsContent(this.files[0])) {
                attachFileButton.textContent = "Attached: " + this.files[0].name;
                fileOversized();
            }
        }
    });

    dropContainer.ondragover = dropContainer.ondragenter = function (evt) {
        evt.preventDefault();
        if (hiddenFileButton.files.length == 0) {
            attachFileButton.textContent = "Drop your file here";
        } else {
            attachFileButton.textContent = "Drop your file here to replace " + hiddenFileButton.files[0].name;
        }
    };

    dropContainer.ondrop = function (evt) {
        evt.preventDefault();
        const file = evt.dataTransfer.files[0];
        if (!handleFileAsContent(file)) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            hiddenFileButton.files = dataTransfer.files;
            attachFileButton.textContent = "Attached: " + file.name;
        }
    };
    // {%- endif %}


</script>

<style>
    input::file-selector-button {
        display: none;
    }

    #settings {
        display: grid;
        grid-gap: 10px;
        grid-template-columns: repeat(auto-fit, 132px);
        grid-template-rows: repeat(1, 90px);
        margin-bottom: 1rem;
    }

    select {
        height: 3rem;

    }

    /* {% if !args.pure_html %} */
    #attach-file-button-label {
        cursor: pointer;
        padding: 0.5rem;
        border: #2975D2 2px dotted;
        border-radius: 6px;
        padding-left: 1rem;
        padding-right: 1rem;
        font-size: smaller;
        min-width: 235px;
        text-align: center;
    }

    /* {% endif %} */

    #file {
        display: none;
    }

    #file-select {
        /* flexbox handles positioning now */
    }

    /* Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        max-width: 350px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    @media (prefers-color-scheme: dark) {
        .modal-content {
            background: #1a1a2e;
            color: #eee;
        }
        .modal-content input {
            background: #16213e;
            border: 1px solid #444;
            color: #eee;
        }
    }

    /* Helper text styles */
    .helper-text {
        font-size: 0.85em;
        color: #666;
        margin-top: 0.25rem;
    }

    @media (prefers-color-scheme: dark) {
        .helper-text {
            color: #aaa;
        }
    }
</style>

{% include "footer.html" %}
